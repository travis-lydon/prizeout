
var _ 			= require('underscore');
var path 		= require('path');
var fs 			= require('fs');
var request 	= require('request');
var walk    	= require('walk');
var pstack    	= require('pstack');
var http		= require('http');
var https		= require('https');
var URL			= require('url');

var file = {
	directory:	{
		list:	function(from, callback) {
			fs.readdir(from, function(err, files) {
				var output 	= [];
				_.each(files, function(file) {
					if(fs.statSync(path.normalize(from+'/'+file)).isDirectory()) {
						output.push(file);
					}
				});
				callback(output);
			});
		},
		mkdir:	function(basepath, pathstr, callback) {
			var parts = pathstr.split("/");
			parts = _.compact(parts);
			var pointer = "";
			
			var checkstack = new pstack();
			
			_.each(parts, function(part) {
				checkstack.add(function(cb) {
					pointer += part+"/";
					fs.exists(path.normalize(basepath+'/'+pointer), function(exists) {
						if (!exists) {
							fs.mkdir(path.normalize(basepath+'/'+pointer), 0777, function() {
								cb();
							});
						} else {
							cb();
						}
					});
				});
			});
			
			checkstack.start(function() {
				callback();
			});
		}
	},
	file:	{
		list:	function(from, callback) {
			fs.readdir(from, function(err, files) {
				var output 	= [];
				_.each(files, function(file) {
					if(!fs.statSync(path.normalize(from+'/'+file)).isDirectory()) {
						output.push(file);
					}
				});
				callback(output);
			});
		},
		listAll:	function(dir, ext, callback) {
			var options = {
				followLinks: 	false
			};
			
			var files   = [];
			
			// Walker options
			var walker  = walk.walk(dir, options);
			
			if (_.isArray(ext)) {
				walker.on('file', function(root, stat, next) {
					var extname = path.extname(stat.name);
					if (_.contains(ext, extname)) {
						files.push(path.normalize(root + '/' + stat.name));
					}
					next();
				});
			} else {
				walker.on('file', function(root, stat, next) {
					var extname = path.extname(stat.name);
					if (extname == ext || !ext) {
						files.push(path.normalize(root + '/' + stat.name));
					}
					next();
				});
			}
			
			
			walker.on('end', function() {
				callback(files);
			});
		},
		exists:	function(file, callback) {
			fs.exists(file, function(exists) {
				callback(exists);
			});
		},
		read:	function(filename, callback) {
			if (filename.substr(0,4) == "http") {
				var ua = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_6_8) AppleWebKit/534.57.2 (KHTML, like Gecko) Version/5.1.7 Safari/534.57.2';
				request.get(filename, {
					headers : {
			            "User-Agent" : ua
			        }
				},function (error, response, body) {
					//console.log("error",error);
					//console.log(body);
					if (!error && response.statusCode == 200) {
						callback(body);
					} else {
						callback(false);
					}
				});
			} else {
				fs.readFile(filename, 'utf8', function (err, data) {
					if (err) {
						callback(false);
					} else {
						callback(data);
					}
				});
			}
		},
		readJson:	function(filename, callback) {
			if (filename.substr(0,4) == "http") {
				request.get(filename, function (error, response, body) {
					if (!error && response.statusCode == 200) {
						callback(JSON.parse(body));
					} else {
						callback(null);
					}
				});
			} else {
				fs.readFile(filename, 'utf8', function (err, data) {
					if (err) {
						callback(null);
					} else {
						callback(JSON.parse(data));
					}
				});
			}
		},
		write:	function(filename, content, callback) {
			fs.writeFile(filename, content, callback);
		},
		writeJson:	function(filename, content, callback) {
			fs.writeFile(filename, JSON.stringify(content), callback);
		},
		remove:	function(filename, callback) {
			fs.unlink(filename, callback);
		},
		download:	function(filename, output, callback) {
			
			var file = fs.createWriteStream(output);
			
			var request = https.get(filename, function(response) {
				response.pipe(file);
				file.on('finish', function() {
					file.close(function() {
						callback(output);
					});
				});
			}).on('error', function(err) {
				fs.unlink(dest);
				callback(false);
			});
		}
	}
};

module.exports = file;
